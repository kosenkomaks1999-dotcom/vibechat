# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Firebase –≤ VibeChat

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã

### 1. ‚ùå –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã Firebase
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `loadRoomsList()` –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ, –∫–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∞—è –∑–∞–ø—Ä–æ—Å –∫ Firebase.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.

```javascript
// –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
async function loadRoomsList() {
  const snapshot = await db.ref("rooms").once('value'); // –ö–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
  // ...
}

// –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
const roomsCache = new RoomsCache();

async function loadRoomsList(force = false) {
  const allRooms = await roomsCache.get(async () => {
    const snapshot = await db.ref("rooms").once('value');
    return snapshot.val() || {};
  });
  // –ö—ç—à –∂–∏–≤–µ—Ç 5 —Å–µ–∫—É–Ω–¥, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Firebase –Ω–∞ 80-90%
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### 2. ‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ Firebase
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –Ω–æ–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –±–µ–∑ –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –£—Ç–µ—á–∫–∞–º –ø–∞–º—è—Ç–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º UI
- –õ–∞–≥–∞–º –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–º–Ω–∞—Ç

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –º–µ–Ω–µ–¥–∂–µ—Ä —Å–ª—É—à–∞—Ç–µ–ª–µ–π `FirebaseListenersManager`.

```javascript
// –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
function startRoomsListener() {
  if (roomsListener) {
    roomsListener.off(); // –ù–µ –≤—Å–µ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ
  }
  roomsListener = roomsRef.on("child_added", callback);
  // –°–ª—É—à–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
}

// –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
const listenersManager = new FirebaseListenersManager();

function startRoomsListener() {
  if (listenersManager.has('rooms')) {
    return; // –°–ª—É—à–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
  }
  
  listenersManager.registerMultiple('rooms', roomsRef, [
    { event: 'child_added', callback: onChildAdded },
    { event: 'child_changed', callback: onChildChanged },
    { event: 'child_removed', callback: onChildRemoved }
  ]);
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ù–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã

### RoomsCache (`src/utils/rooms-cache.js`)
–ö—ç—à –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.

**–ú–µ—Ç–æ–¥—ã:**
- `get(loadFunction)` - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å)
- `invalidate()` - –ü–æ–º–µ—Ç–∏—Ç—å –∫—ç—à –∫–∞–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π
- `clear()` - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
- `updateRoom(roomId, roomData)` - –û–±–Ω–æ–≤–∏—Ç—å –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É –≤ –∫—ç—à–µ

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `cacheTimeout: 5000` - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ (5 —Å–µ–∫—É–Ω–¥)

### FirebaseListenersManager (`src/utils/firebase-listeners.js`)
–ú–µ–Ω–µ–¥–∂–µ—Ä Firebase —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏.

**–ú–µ—Ç–æ–¥—ã:**
- `register(id, ref, event, callback)` - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å
- `registerMultiple(id, ref, events)` - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π
- `unregister(id)` - –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è
- `unregisterAll()` - –û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
- `has(id)` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–ª—É—à–∞—Ç–µ–ª—å
- `count()` - –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
- `list()` - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç

```javascript
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞
await loadRoomsList(); // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à, –µ—Å–ª–∏ –æ–Ω –≤–∞–ª–∏–¥–µ–Ω

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫—ç—à)
await loadRoomsList(true);

// –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
roomsCache.invalidate();
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª—è–º–∏

```javascript
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è
listenersManager.register('rooms', roomsRef, 'child_added', callback);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
listenersManager.registerMultiple('rooms', roomsRef, [
  { event: 'child_added', callback: onAdd },
  { event: 'child_changed', callback: onChange }
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
if (listenersManager.has('rooms')) {
  console.log('–°–ª—É—à–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
}

// –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
listenersManager.unregister('rooms');

// –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)
listenersManager.unregisterAll();
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è –∫–æ–º–Ω–∞—Ç

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```javascript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è event "value" - –∑–∞–≥—Ä—É–∂–∞–ª –í–°–ï –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –ö–ê–ñ–î–û–ú –∏–∑–º–µ–Ω–µ–Ω–∏–∏
roomsRef.on("value", (snap) => {
  const allRooms = snap.val(); // –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã
  renderRoomsList(allRooms);
});
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```javascript
// –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è "child_*" - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
roomsRef.on("child_added", (snap) => {
  const roomId = snap.key;
  const roomData = snap.val();
  roomsCache.updateRoom(roomId, roomData); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É
  scheduleUpdate(); // Debounce 1 —Å–µ–∫—É–Ω–¥–∞
});

roomsRef.on("child_changed", (snap) => {
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
});

roomsRef.on("child_removed", (snap) => {
  roomsCache.updateRoom(snap.key, null); // –£–¥–∞–ª—è–µ–º –∏–∑ –∫—ç—à–∞
  scheduleUpdate();
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ Firebase –Ω–∞ 95%
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ Debounce –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- üìä –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ Firebase: ~50-100 –≤ –º–∏–Ω—É—Ç—É
- üìä –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π: 5-10 (—Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏)
- üìä –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç: 500-1000ms
- üìä –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏: –î–∞ (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ Firebase: ~5-10 –≤ –º–∏–Ω—É—Ç—É (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 90%)
- ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π: 3 (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- ‚úÖ –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç: 10-50ms (–∏–∑ –∫—ç—à–∞)
- ‚úÖ –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏: –ù–µ—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞)

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–ª—É—à–∞—Ç–µ–ª–µ–π** –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Firebase –ø–æ–¥–ø–∏—Å–æ–∫
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à** –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∫—ç—à** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –¥–∞–Ω–Ω—ã—Ö
4. **–û—á–∏—â–∞–π—Ç–µ —Å–ª—É—à–∞—Ç–µ–ª–∏** –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ debounce** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π UI

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- [ ] –î–æ–±–∞–≤–∏—Ç—å offline-—Ä–µ–∂–∏–º —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å prefetching –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Firebase

---

**–î–∞—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** 12 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.1.0-performance-fix-v4

/**
 * –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è VibeChat
 * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ –º–æ–¥—É–ª–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * 
 * –†–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
 */

import { CONSTANTS } from './modules/constants.js';
import { initFirebase, getRoomRef, createUserInRoom, updateUserMuteStatus, clearRoomMessages, getRoomsList, getRoomInfo } from './modules/firebase.js';
import { FriendsManager } from './modules/friends.js';
import { AuthManager } from './modules/auth.js';
import { WebRTCManager } from './modules/webrtc.js';
import { ChatManager } from './modules/chat.js';
import { UIManager } from './modules/ui.js';
import { UsersManager } from './modules/users.js';
import { SpeechDetector } from './modules/speech.js';
import { DevicesManager } from './modules/devices.js';
import { ConnectionManager } from './modules/connection.js';
import { playNotificationSound } from './modules/sounds.js';
import { logger } from './modules/logger.js';
import { errorHandler, ErrorCodes } from './modules/error-handler.js';
import { AppState } from './app/app-state.js';
import { AuthHandlers } from './app/auth-handlers.js';
import { RoomHandlers } from './app/room-handlers.js';
import { ProfileHandlers } from './app/profile-handlers.js';

document.addEventListener("DOMContentLoaded", async () => {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è)
  logger.info('=== VibeChat –∑–∞–ø—É—â–µ–Ω ===').catch(() => {});
  logger.info('–í–µ—Ä—Å–∏—è:', { timestamp: new Date().toISOString() }).catch(() => {});
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º ErrorHandler –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const ui = new UIManager();
  errorHandler.setUIToastCallback((message) => ui.showToast(message));
  
  const splashScreen = document.getElementById('splashScreen');
  const appContent = document.getElementById('appContent');
  const authWindow = document.getElementById('authWindow');

  // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  if (authWindow) {
    authWindow.style.display = 'none';
  }
  if (appContent) {
    appContent.style.display = 'none';
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  let db, auth;
  let authManager = null;
  
  try {
    const firebaseInit = initFirebase();
    db = firebaseInit.database;
    auth = firebaseInit.auth;
    authManager = new AuthManager(auth);
    logger.info('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ').catch(() => {});
  } catch (error) {
    errorHandler.handle(error, { operation: 'initFirebase' }, { 
      code: ErrorCodes.FIREBASE_INIT_FAILED,
      userMessage: '–û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª config/firebase.config.js'
    });
    
    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ splash screen
    setTimeout(() => {
      if (splashScreen) {
        splashScreen.classList.add('fade-out');
        setTimeout(() => {
          if (splashScreen && splashScreen.parentNode) {
            splashScreen.remove();
          }
          if (authWindow) {
            authWindow.style.display = 'flex';
          }
        }, 1200);
      }
    }, 2000);
    return;
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const state = new AppState();
  state.db = db;
  state.auth = auth;
  state.authManager = authManager;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
  state.ui = ui;
  state.devices = new DevicesManager();
  state.webrtc = new WebRTCManager(null, null, null);
  state.usersManager = new UsersManager(state.webrtc.audios, state.webrtc.userVolumes);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
  ui.initEmojiPicker();
  ui.initBackgroundSettings();
  ui.initAppearanceSettings();
  ui.initAuthHandlers();
  state.devices.initElements();
  state.devices.setupCloseHandlers();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —Ä–µ—á–∏
  const speechDetector = new SpeechDetector(
    state.webrtc.audioAnalysers,
    state.webrtc.speakingStates,
    state.webrtc.localAudioAnalyser,
    state.webrtc.localStream,
    state.myId,
    state.muted
  );
  state.speechDetector = speechDetector;

  speechDetector.setOnSpeakingChange((userId, isSpeaking) => {
    if (isSpeaking) {
      state.usersManager.markSpeaking(userId);
    } else {
      state.usersManager.markNotSpeaking(userId);
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  function showAuth() {
    logger.info('–ü–æ–∫–∞–∑–∞–Ω–æ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏').catch(() => {});
    
    if (window.electronAPI && window.electronAPI.setWindowSize) {
      window.electronAPI.setWindowSize(500, 750, true);
    }
    
    ui.showAuthWindow();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async function initApp() {
    try {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if (window.electronAPI && window.electronAPI.restoreWindowSize) {
        window.electronAPI.restoreWindowSize(1200, 650, 1065, 550, true);
      }
      
      // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      if (authWindow) {
        authWindow.style.display = 'none';
        authWindow.classList.remove('show');
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      if (appContent) {
        appContent.style.display = 'flex';
        appContent.style.opacity = '1';
        appContent.style.visibility = 'visible';
        appContent.classList.add('show');
        appContent.style.position = 'relative';
        appContent.style.zIndex = '10';
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫–Ω–µ–π–º
      if (authManager) {
        const currentUser = authManager.getCurrentUser();
        if (currentUser && currentUser.email) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–∑ Firebase
          try {
            const { getUserNickname, getUserAvatar, setUserOnlineStatus } = await import('./modules/firebase.js');
            const savedNickname = await getUserNickname(db, currentUser.uid);
            if (savedNickname) {
              ui.setNicknameDisplay(savedNickname);
              ui.saveNickname(savedNickname);
              state.myNick = savedNickname;
            } else {
              ui.setNicknameDisplay('–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
              state.myNick = CONSTANTS.DEFAULT_NICKNAME;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
              const avatarUrl = await getUserAvatar(db, currentUser.uid);
              ui.setUserAvatar(avatarUrl, savedNickname || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } catch (avatarError) {
              errorHandler.handleSilent(avatarError, { operation: 'getUserAvatar' });
              ui.setUserAvatar(null, savedNickname || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º email –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
              const userEmailSnapshot = await db.ref(`users/${currentUser.uid}/email`).once('value');
              if (!userEmailSnapshot.exists() && currentUser.email) {
                await db.ref(`users/${currentUser.uid}/email`).set(currentUser.email);
              }
            } catch (emailError) {
              errorHandler.handleSilent(emailError, { operation: 'updateEmail' });
            }
          } catch (error) {
            errorHandler.handle(error, { operation: 'loadUserProfile' });
            ui.setNicknameDisplay('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            ui.setUserAvatar(null, '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            state.myNick = CONSTANTS.DEFAULT_NICKNAME;
          }
          
          logger.info('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', { email: currentUser.email }).catch(() => {});
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç —Å userId –∏ db
          if (!state.chat) {
            state.chat = new ChatManager(null, state.myNick, currentUser.uid, db);
            state.chat.initElements(
              ui.elements.chatMessages,
              ui.elements.chatInput,
              ui.elements.fileInput
            );
            state.chat.showEmptyState();
          } else {
            state.chat.myUserId = currentUser.uid;
            state.chat.db = db;
          }
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –¥—Ä—É–∑–µ–π
          if (!state.friendsManager) {
            state.friendsManager = new FriendsManager(db, authManager, () => {
              playNotificationSound('join');
            });
            state.friendsManager.initElements(
              ui.elements.friendsList,
              ui.elements.notificationsList,
              ui.elements.notificationsBadge
            );
            
            state.friendsManager.loadFriends();
            state.friendsManager.loadNotifications();
            state.friendsManager.startListeningToRequests();
            state.friendsManager.startListeningToFriends();
          }
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å
          const { setUserOnlineStatus } = await import('./modules/firebase.js');
          await setUserOnlineStatus(db, currentUser.uid, true);
        } else {
          logger.warn('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è').catch(() => {});
        }
      }
      
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤—ã—à–µ)
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–Ω–∞—Ç
      const roomHandlers = new RoomHandlers(
        state,
        ui,
        authManager,
        db,
        state.devices,
        state.webrtc,
        state.chat,
        state.usersManager,
        state.connectionManager,
        speechDetector
      );
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º callback –¥–ª—è setupListeners
      roomHandlers.setSetupListenersCallback(() => {
        setupListeners();
      });
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º callback –¥–ª—è loadRoomsList
      roomHandlers.setLoadRoomsListCallback(() => {
        return loadRoomsList();
      });
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º roomHandlers –≤ state –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç
      state.roomHandlers = roomHandlers;
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
      const profileHandlers = new ProfileHandlers(state, ui, authManager, db);
      profileHandlers.init();
      state.profileHandlers = profileHandlers;
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI –¥–ª—è –∫–æ–º–Ω–∞—Ç
      setupRoomUIHandlers(roomHandlers);
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥—Ä—É–∑–µ–π
      setupFriendsHandlers();
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ UI –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      setupOtherUIHandlers();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º connectionManager –≤ roomHandlers –ø–æ—Å–ª–µ –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
      if (state.roomHandlers && state.connectionManager) {
        state.roomHandlers.connectionManager = state.connectionManager;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
      setTimeout(async () => {
        try {
          const currentUser = authManager?.getCurrentUser();
          if (!currentUser) {
            return;
          }
          
          await loadRoomsList();
          startRoomsListener();
        } catch (error) {
          errorHandler.handle(error, { operation: 'loadRoomsListOnInit' });
        }
      }, 500);
      
    } catch (error) {
      errorHandler.handle(error, { operation: 'initApp' });
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Å–æ–∑–¥–∞–µ–º –¥–æ initApp)
  state.connectionManager = new ConnectionManager(
    db,
    (status) => {
      if (state.intentionalLeave) {
        return;
      }
      
      if (!state.roomRef || !state.joined) {
        ui.updateConnectionStatus(status);
        return;
      }
      
      ui.updateConnectionStatus(status);
      
      if (status === 'disconnected' && state.joined && !state.intentionalLeave && state.roomRef) {
        ui.showToast("–ü–æ—Ç–µ—Ä—è–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É", CONSTANTS.TOAST_DURATION * 2);
      }
    },
    null
  );
  state.connectionManager.init();
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  db.ref('.info/connected').once('value', (snap) => {
    const isConnected = snap.val() === true;
    ui.updateConnectionStatus(isConnected ? 'connected' : 'disconnected');
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const authHandlers = new AuthHandlers(state, ui, authManager, db, auth, initApp);
  authHandlers.init();
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
  authHandlers.setupLogoutHandler(
    () => {
      // Callback –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ roomHandlers
      if (state.roomHandlers) {
        return state.roomHandlers.leaveRoom();
      }
      return Promise.resolve();
    },
    showAuth
  );

  // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è splash screen –∏ –ø–æ–∫–∞–∑–∞ –Ω—É–∂–Ω–æ–≥–æ –æ–∫–Ω–∞
  let splashProcessed = false;
  function hideSplashAndShow(isAuthorized) {
    if (splashProcessed) return;
    splashProcessed = true;

    if (splashScreen && !splashScreen.classList.contains('fade-out')) {
      splashScreen.classList.add('fade-out');
      
      setTimeout(() => {
        if (splashScreen && splashScreen.parentNode) {
          splashScreen.remove();
        }
        
        if (isAuthorized) {
          initApp();
        } else {
          showAuth();
        }
      }, 1200);
    } else {
      if (isAuthorized) {
        initApp();
      } else {
        showAuth();
      }
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (authManager) {
    const minSplashTime = 2000;
    const splashStartTime = Date.now();
    let authStateResolved = false;
    
    authManager.onAuthStateChanged((user) => {
      if (authStateResolved) {
        return;
      }
      authStateResolved = true;
      
      const isAuthorized = user !== null && user !== undefined;
      
      logger.info('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', {
        isAuthorized,
        email: user ? user.email : null,
        uid: user ? user.uid : null
      }).catch(() => {});
      
      const elapsed = Date.now() - splashStartTime;
      const remainingTime = Math.max(0, minSplashTime - elapsed);
      
      setTimeout(() => {
        if (isAuthorized) {
          logger.info('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', { email: user.email }).catch(() => {});
          hideSplashAndShow(true);
        } else {
          logger.info('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏').catch(() => {});
          hideSplashAndShow(false);
        }
      }, remainingTime);
    });
  } else {
    setTimeout(() => {
      hideSplashAndShow(false);
    }, 2000);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–∞—Ç–∞
  usersManager.initElement(ui.elements.usersEl);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —Ä–µ—á–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const updateSpeechDetector = () => {
    speechDetector.setMuted(state.muted);
    speechDetector.updateLocalAnalyser(state.webrtc.localAudioAnalyser, state.webrtc.localStream);
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π UI
  
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  const toggleMute = () => {
    state.muted = !state.muted;
    state.webrtc.toggleMute(state.muted);
    ui.updateMuteButton(state.muted);
    updateUserMuteStatus(state.myUserRef, state.muted);
    updateSpeechDetector();
  };

  if (ui.elements.muteBtn) {
    ui.elements.muteBtn.addEventListener("click", toggleMute);
    ui.elements.muteBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      state.devices.showMicSelector();
    });
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–æ–≤
  const toggleSpeaker = () => {
    const speakerMuted = state.webrtc.toggleSpeaker();
    ui.updateSpeakerButton(speakerMuted);
  };

  if (ui.elements.speakerBtn) {
    ui.elements.speakerBtn.addEventListener("click", toggleSpeaker);
    ui.elements.speakerBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      state.devices.showSpeakerSelector();
    });
  }

  // –í—ã–±–æ—Ä –¥–∏–Ω–∞–º–∏–∫–æ–≤
  if (state.devices.speakerSelect) {
    state.devices.speakerSelect.addEventListener('change', () => {
      state.webrtc.applySpeakerSelection(state.devices.speakerSelect.value);
    });
    state.webrtc.setSpeakerSelect(state.devices.speakerSelect);
  }

  // –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  if (state.devices.micSelect) {
    state.devices.micSelect.addEventListener('change', async () => {
      if (state.joined) {
        const deviceId = state.devices.getSelectedMicId();
        await state.webrtc.updateMicrophone(deviceId);
        updateSpeechDetector();
      }
    });
  }

  // –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
  if (ui.elements.attachBtn) {
    ui.elements.attachBtn.addEventListener("click", () => {
      ui.elements.fileInput.click();
    });
  }

  if (ui.elements.fileInput) {
    ui.elements.fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && state.chat) {
        state.chat.attachFile(file, (msg) => ui.showToast(msg));
      }
    });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  if (ui.elements.sendBtn) {
    ui.elements.sendBtn.addEventListener("click", () => {
      if (state.chat) {
        state.chat.sendMessage(ui.showToast.bind(ui));
      }
    });
  }

  if (ui.elements.chatInput) {
    ui.elements.chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && state.chat) {
        state.chat.sendMessage(ui.showToast.bind(ui));
      }
    });
  }

  // –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä
  if (ui.elements.emojiBtn) {
    ui.elements.emojiBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      ui.elements.emojiPicker.classList.toggle("show");
    });
  }

  document.addEventListener("click", (e) => {
    if (ui.elements.emojiPicker && !ui.elements.emojiPicker.contains(e.target) && e.target !== ui.elements.emojiBtn) {
      ui.elements.emojiPicker.classList.remove("show");
    }
  });

  // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
  if (ui.elements.clearChatBtn) {
    ui.elements.clearChatBtn.addEventListener("click", async () => {
      if (!state.chat) {
        ui.showToast("–ß–∞—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        return;
      }
      
      if (state.joined && state.roomRef) {
        const confirmed = await ui.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ?");
        if (confirmed) {
          state.chat.clear();
          clearRoomMessages(state.roomRef);
          ui.showToast("–ß–∞—Ç –æ—á–∏—â–µ–Ω");
        }
      } else {
        state.chat.clear();
        ui.showToast("–ß–∞—Ç –æ—á–∏—â–µ–Ω");
      }
    });
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ UI –¥–ª—è –∫–æ–º–Ω–∞—Ç
  function setupRoomUIHandlers(roomHandlers) {
    // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.createRoomBtn) {
      ui.elements.createRoomBtn.addEventListener("click", () => {
        roomHandlers.showCreateRoomModal();
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.createRoomCloseBtn) {
      ui.elements.createRoomCloseBtn.addEventListener('click', () => {
        if (ui.elements.createRoomModal) {
          ui.elements.createRoomModal.classList.remove('show');
        }
      });
    }

    if (ui.elements.createRoomCancelBtn) {
      ui.elements.createRoomCancelBtn.addEventListener('click', () => {
        if (ui.elements.createRoomModal) {
          ui.elements.createRoomModal.classList.remove('show');
        }
      });
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.createRoomSubmitBtn && ui.elements.roomNameInput && ui.elements.roomIdDisplayInput) {
      ui.elements.createRoomSubmitBtn.addEventListener('click', async () => {
        const roomId = ui.elements.roomIdDisplayInput.value.trim();
        const roomName = ui.elements.roomNameInput.value.trim();
        
        if (!roomName) {
          if (ui.elements.createRoomError) {
            ui.elements.createRoomError.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã';
            ui.elements.createRoomError.style.display = 'block';
          }
          return;
        }

        await roomHandlers.createRoomWithName(roomId, roomName);
      });
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.roomNameInput) {
      ui.elements.roomNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && ui.elements.createRoomSubmitBtn) {
          ui.elements.createRoomSubmitBtn.click();
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    if (ui.elements.createRoomModal) {
      ui.elements.createRoomModal.addEventListener('click', (e) => {
        if (e.target === ui.elements.createRoomModal) {
          ui.elements.createRoomModal.classList.remove('show');
        }
      });
    }

    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.findRoomBtn) {
      ui.elements.findRoomBtn.addEventListener("click", () => {
        if (ui.elements.findRoomModal) {
          ui.elements.findRoomModal.classList.add('show');
          if (ui.elements.roomIdInput) {
            ui.elements.roomIdInput.value = '';
            ui.elements.roomIdInput.focus();
          }
          if (ui.elements.findRoomError) {
            ui.elements.findRoomError.textContent = '';
            ui.elements.findRoomError.style.display = 'none';
          }
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.findRoomCloseBtn) {
      ui.elements.findRoomCloseBtn.addEventListener('click', () => {
        if (ui.elements.findRoomModal) {
          ui.elements.findRoomModal.classList.remove('show');
        }
      });
    }

    if (ui.elements.findRoomCancelBtn) {
      ui.elements.findRoomCancelBtn.addEventListener('click', () => {
        if (ui.elements.findRoomModal) {
          ui.elements.findRoomModal.classList.remove('show');
        }
      });
    }

    // –ü–æ–∏—Å–∫ –∏ –≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    if (ui.elements.findRoomSubmitBtn && ui.elements.roomIdInput) {
      ui.elements.findRoomSubmitBtn.addEventListener('click', async () => {
        const roomId = ui.elements.roomIdInput.value.trim();
        
        if (!roomId) {
          if (ui.elements.findRoomError) {
            ui.elements.findRoomError.textContent = '–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã';
            ui.elements.findRoomError.style.display = 'block';
          }
          return;
        }

        try {
          if (ui.elements.findRoomModal) {
            ui.elements.findRoomModal.classList.remove('show');
          }

          await roomHandlers.findAndJoinRoom(roomId);
        } catch (error) {
          errorHandler.handle(error, { operation: 'findRoom' });
          if (ui.elements.findRoomError) {
            ui.elements.findRoomError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –∫–æ–º–Ω–∞—Ç–µ';
            ui.elements.findRoomError.style.display = 'block';
          }
        }
      });
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç—ã
    if (ui.elements.roomIdInput) {
      ui.elements.roomIdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && ui.elements.findRoomSubmitBtn) {
          ui.elements.findRoomSubmitBtn.click();
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    if (ui.elements.findRoomModal) {
      ui.elements.findRoomModal.addEventListener('click', (e) => {
        if (e.target === ui.elements.findRoomModal) {
          ui.elements.findRoomModal.classList.remove('show');
        }
      });
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª–µ–π Firebase
  function setupListeners() {
    if (!state.roomRef) return;

    // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
    state.roomRef.child("users").off();
    state.roomRef.child("signals").off();
    state.roomRef.child("messages").off();

    // –°–ª—É—à–∞—Ç–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    state.roomRef.child("users").on("value", snap => {
      const users = snap.val() || {};
      const currentUsersCount = Object.keys(users).length;

      if (state.joined) {
        ui.updateUsersCount(currentUsersCount);
      }

      if (state.joined && state.previousUsersCount > 0 && state.previousUsersCount !== currentUsersCount) {
        const isMeInRoom = state.myId && users[state.myId];
        if (isMeInRoom) {
          if (currentUsersCount > state.previousUsersCount) {
            playNotificationSound('join');
          } else if (currentUsersCount < state.previousUsersCount) {
            playNotificationSound('leave');
          }
        }
        state.previousUsersCount = currentUsersCount;
      }

      speechDetector.updateUserMutedStates(users);

      state.usersManager.updateUsersList(users, (userId, volume) => {
        state.webrtc.setUserVolume(userId, volume);
      });

      if (state.joined) {
        const count = Object.keys(users).length;
        ui.updateUsersCount(count);
        state.previousUsersCount = count;

        if (count === 0 && state.roomRef) {
          if (state.chat) {
            state.chat.clear();
          }
          state.usersManager.clear();
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
      if (state.joined && state.myUserRef && state.myId && !users[state.myId] && !state.intentionalLeave) {
        state.intentionalLeave = true;
        if (state.roomHandlers) {
          state.roomHandlers.forceLeaveRoom(true, "–í—ã –±—ã–ª–∏ –≤—ã–∫–∏–Ω—É—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!").catch(error => {
            errorHandler.handle(error, { operation: 'forceLeaveAfterRemoval' });
          });
        }
      }
    });

    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–∏–≥–Ω–∞–ª–æ–≤ WebRTC
    state.roomRef.child("signals").on("child_added", snap => {
      const data = snap.val();
      if (!data || data.to !== state.myId) return;
      state.webrtc.handleSignal(data);
      snap.ref.remove().catch(() => {});
    });

    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π
    state.roomRef.child("messages").on("child_added", snap => {
      const message = snap.val();
      if (message && state.chat) {
        state.chat.displayMessage(message).catch(error => {
          errorHandler.handleSilent(error, { operation: 'displayMessage' });
        });
      }
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
  async function loadRoomsList(force = false) {
    try {
      if (!db) {
        throw new Error('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
      }
      
      const currentUser = authManager?.getCurrentUser();
      if (!currentUser) {
        throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      }
      
      const snapshot = await db.ref("rooms").once('value');
      const rooms = snapshot.val() || {};
      
      renderRoomsList(rooms);
    } catch (error) {
      errorHandler.handle(error, { operation: 'loadRoomsList' });
    }
  }

  // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
  function renderRoomsList(rooms) {
    if (!ui.elements.roomsList) {
      ui.initElements();
    }
    
    const roomsListEl = ui.elements?.roomsList || document.getElementById('roomsList');
    const roomsEmptyEl = ui.elements?.roomsEmpty || document.getElementById('roomsEmpty');
    
    if (!roomsListEl) return;
    
    roomsListEl.innerHTML = '';
    
    const roomsArray = Object.entries(rooms || {});
    
    if (roomsArray.length === 0) {
      if (roomsEmptyEl) {
        roomsEmptyEl.style.display = 'block';
      }
      return;
    }
    
    if (roomsEmptyEl) {
      roomsEmptyEl.style.display = 'none';
    }
    
    roomsArray.forEach(([roomId, roomData]) => {
      const roomElement = createRoomElement(roomId, roomData);
      roomsListEl.appendChild(roomElement);
    });
  }

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–æ–º–Ω–∞—Ç—ã
  function createRoomElement(roomId, roomData) {
    const roomDiv = document.createElement('div');
    roomDiv.className = 'room-item';
    roomDiv.dataset.roomId = roomId;
    
    const usersCount = roomData?.users ? Object.keys(roomData.users).length : 0;
    const roomName = roomData?.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const isCurrentRoom = state.currentRoomId === roomId && state.joined;
    
    roomDiv.innerHTML = `
      <div class="room-name">${escapeHtml(roomName)}</div>
      <div class="room-info">
        <span class="room-users-count">üë• ${usersCount}</span>
        ${isCurrentRoom ? '<span class="room-current">–í—ã –∑–¥–µ—Å—å</span>' : ''}
      </div>
    `;
    
    roomDiv.addEventListener('click', () => {
      if (!isCurrentRoom && !state.joined) {
        if (state.roomHandlers) {
          state.roomHandlers.findAndJoinRoom(roomId);
        }
      }
    });
    
    roomDiv.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showRoomContextMenu(e, roomId, roomData?.creatorId);
    });
    
    return roomDiv;
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –∫–æ–º–Ω–∞—Ç—ã
  function showRoomContextMenu(e, roomId, creatorId) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!ui.elements.roomContextMenu) return;
    
    const currentUser = authManager?.getCurrentUser();
    const isCreator = currentUser && creatorId === currentUser.uid;
    
    if (ui.elements.roomContextDelete) {
      ui.elements.roomContextDelete.style.display = isCreator ? 'block' : 'none';
    }
    
    ui.elements.roomContextMenu.style.display = 'block';
    ui.elements.roomContextMenu.style.left = e.pageX + 'px';
    ui.elements.roomContextMenu.style.top = e.pageY + 'px';
    ui.elements.roomContextMenu.dataset.roomId = roomId;
    
    const closeMenu = (event) => {
      if (ui.elements.roomContextMenu && !ui.elements.roomContextMenu.contains(event.target)) {
        ui.elements.roomContextMenu.style.display = 'none';
        document.removeEventListener('click', closeMenu);
      }
    };
    setTimeout(() => {
      document.addEventListener('click', closeMenu);
    }, 0);
  }

  // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–ª—É—à–∞—Ç–µ–ª—é –∫–æ–º–Ω–∞—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  function startRoomsListener() {
    if (!db) {
      return;
    }
    
    if (state.roomsListener) {
      state.roomsListener.off();
    }

    state.roomsListener = db.ref("rooms").on("value", (snap) => {
      const rooms = snap.val() || {};
      renderRoomsList(rooms);
    }, (error) => {
      errorHandler.handleSilent(error, { operation: 'roomsListener' });
    });
  }

  function stopRoomsListener() {
    if (state.roomsListener) {
      state.roomsListener.off();
      state.roomsListener = null;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
  if (ui.elements.roomContextLeave) {
    ui.elements.roomContextLeave.addEventListener('click', async (e) => {
      e.stopPropagation();
      e.preventDefault();
      
      const roomId = ui.elements.roomContextMenu?.dataset.roomId;
      
      if (state.joined && state.currentRoomId && state.currentRoomId === roomId) {
        if (state.roomHandlers) {
          await state.roomHandlers.leaveRoom();
        }
      } else {
        ui.showToast('–í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ');
      }
      
      if (ui.elements.roomContextMenu) {
        ui.elements.roomContextMenu.style.display = 'none';
      }
    });
  }

  if (ui.elements.roomContextDelete) {
    ui.elements.roomContextDelete.addEventListener('click', async () => {
      const roomId = ui.elements.roomContextMenu?.dataset.roomId;
      if (!roomId) return;

      if (state.roomHandlers) {
        await state.roomHandlers.deleteRoom(roomId);
        await loadRoomsList();
      }
      
      if (ui.elements.roomContextMenu) {
        ui.elements.roomContextMenu.style.display = 'none';
      }
    });
  }

  // ConnectionManager —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤—ã—à–µ, –ø–µ—Ä–µ–¥ initApp

  // –ó–∞–ø—É—Å–∫ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —Ä–µ—á–∏
  speechDetector.startDetection();

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥—Ä—É–∑–µ–π
  function setupFriendsHandlers() {
    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞ –≤ title bar
    if (ui.elements.addFriendBtnTitle) {
      ui.elements.addFriendBtnTitle.addEventListener('click', () => {
        if (ui.elements.addFriendModal) {
          ui.elements.addFriendModal.classList.add('show');
          if (ui.elements.friendNicknameInput) {
            ui.elements.friendNicknameInput.value = '';
            ui.elements.friendNicknameInput.focus();
          }
          if (ui.elements.addFriendError) {
            ui.elements.addFriendError.textContent = '';
            ui.elements.addFriendError.style.display = 'none';
          }
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞
    if (ui.elements.addFriendCloseBtn) {
      ui.elements.addFriendCloseBtn.addEventListener('click', () => {
        if (ui.elements.addFriendModal) {
          ui.elements.addFriendModal.classList.remove('show');
        }
      });
    }

    if (ui.elements.addFriendCancelBtn) {
      ui.elements.addFriendCancelBtn.addEventListener('click', () => {
        if (ui.elements.addFriendModal) {
          ui.elements.addFriendModal.classList.remove('show');
        }
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è
    if (ui.elements.addFriendSubmitBtn && ui.elements.friendNicknameInput) {
      ui.elements.addFriendSubmitBtn.addEventListener('click', async () => {
        const nickname = ui.elements.friendNicknameInput.value.trim();
        
        if (!nickname) {
          if (ui.elements.addFriendError) {
            ui.elements.addFriendError.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º';
            ui.elements.addFriendError.style.display = 'block';
          }
          return;
        }

        if (!state.friendsManager) {
          if (ui.elements.addFriendError) {
            ui.elements.addFriendError.textContent = '–ú–µ–Ω–µ–¥–∂–µ—Ä –¥—Ä—É–∑–µ–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
            ui.elements.addFriendError.style.display = 'block';
          }
          return;
        }

        try {
          const result = await state.friendsManager.sendFriendRequestByNickname(nickname);
          if (result.success) {
            ui.showToast('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            if (ui.elements.addFriendModal) {
              ui.elements.addFriendModal.classList.remove('show');
            }
            if (ui.elements.friendNicknameInput) {
              ui.elements.friendNicknameInput.value = '';
            }
          } else {
            errorHandler.handle(
              result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞',
              { operation: 'sendFriendRequest', nickname },
              { userMessage: result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞' }
            );
            if (ui.elements.addFriendError) {
              ui.elements.addFriendError.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞';
              ui.elements.addFriendError.style.display = 'block';
            }
          }
        } catch (error) {
          errorHandler.handle(error, { operation: 'sendFriendRequest' });
          if (ui.elements.addFriendError) {
            ui.elements.addFriendError.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞';
            ui.elements.addFriendError.style.display = 'block';
          }
        }
      });
    }

    // –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if (ui.elements.notificationsBtn) {
      ui.elements.notificationsBtn.addEventListener('click', async () => {
        if (ui.elements.notificationsModal) {
          ui.elements.notificationsModal.classList.add('show');
          if (state.friendsManager) {
            await state.friendsManager.loadNotifications();
          }
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if (ui.elements.notificationsCloseBtn) {
      ui.elements.notificationsCloseBtn.addEventListener('click', () => {
        if (ui.elements.notificationsModal) {
          ui.elements.notificationsModal.classList.remove('show');
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    if (ui.elements.addFriendModal) {
      ui.elements.addFriendModal.addEventListener('click', (e) => {
        if (e.target === ui.elements.addFriendModal) {
          ui.elements.addFriendModal.classList.remove('show');
        }
      });
    }

    if (ui.elements.notificationsModal) {
      ui.elements.notificationsModal.addEventListener('click', (e) => {
        if (e.target === ui.elements.notificationsModal) {
          ui.elements.notificationsModal.classList.remove('show');
        }
      });
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è
    if (ui.elements.friendNicknameInput) {
      ui.elements.friendNicknameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && ui.elements.addFriendSubmitBtn) {
          ui.elements.addFriendSubmitBtn.click();
        }
      });
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥—Ä—É–≥–∏—Ö UI –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  function setupOtherUIHandlers() {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –ö–æ–º–Ω–∞—Ç—ã/–î—Ä—É–∑—å—è
    if (ui.elements.roomsTab && ui.elements.friendsTab) {
      ui.elements.roomsTab.addEventListener('click', async () => {
        const roomsListEl = ui.elements?.roomsList || document.getElementById('roomsList');
        if (roomsListEl && roomsListEl.children.length === 0) {
          try {
            await loadRoomsList(true);
          } catch (error) {
            errorHandler.handleSilent(error, { operation: 'loadRoomsOnTabSwitch' });
          }
        }
        
        ui.elements.roomsTab.classList.add('active');
        ui.elements.friendsTab.classList.remove('active');
        ui.elements.roomsContent.classList.add('active');
        ui.elements.friendsContent.classList.remove('active');
      });

      ui.elements.friendsTab.addEventListener('click', () => {
        ui.elements.friendsTab.classList.add('active');
        ui.elements.roomsTab.classList.remove('active');
        ui.elements.friendsContent.classList.add('active');
        ui.elements.roomsContent.classList.remove('active');
      });
    }

    // –§–æ–Ω
    if (ui.elements.changeBgBtn) {
      ui.elements.changeBgBtn.addEventListener("click", () => {
        ui.elements.bgSelector.classList.add("show");
      });
    }

    if (ui.elements.bgCloseBtn) {
      ui.elements.bgCloseBtn.addEventListener("click", () => {
        ui.elements.bgSelector.classList.remove("show");
      });
    }

    if (ui.elements.bgSelector) {
      ui.elements.bgSelector.addEventListener("click", (e) => {
        if (e.target === ui.elements.bgSelector) {
          ui.elements.bgSelector.classList.remove("show");
        }
      });
    }

    if (ui.elements.bgCustomBtn) {
      ui.elements.bgCustomBtn.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            ui.setBackground(reader.result);
            document.querySelectorAll(".bg-option").forEach(opt => opt.classList.remove("selected"));
            ui.elements.bgSelector.classList.remove("show");
          };
          reader.readAsDataURL(file);
        };
        input.click();
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
    if (ui.elements.closeBtn) {
      ui.elements.closeBtn.addEventListener("click", () => {
        if (window.electronAPI && window.electronAPI.closeWindow) {
          window.electronAPI.closeWindow();
        } else {
          window.close();
        }
      });
    }

    // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
    const minimizeBtn = document.getElementById("minimizeBtn");
    if (minimizeBtn) {
      minimizeBtn.addEventListener("click", () => {
        if (window.electronAPI && window.electronAPI.minimizeWindow) {
          window.electronAPI.minimizeWindow();
        }
      });
    }
  }

  // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –ª–æ–≥–æ–≤
  if (typeof window !== 'undefined' && window.electronAPI && window.electronAPI.getLogFilePath) {
    window.electronAPI.getLogFilePath().then(logPath => {
      logger.info('–§–∞–π–ª –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω', { path: logPath }).catch(() => {});
    }).catch(error => {
      errorHandler.handleSilent(error, { operation: 'getLogFilePath' });
    });
  }
});


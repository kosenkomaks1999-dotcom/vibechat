# Исправление ошибок PERMISSION_DENIED

## Проблема
Ошибки `PERMISSION_DENIED` при доступе к `/rooms` и `/users/{userId}/online`.

## Причина
Правила безопасности Firebase в консоли не соответствуют текущим требованиям приложения, или пользователь пытается получить доступ до авторизации.

## Решение

### 1. Обновить правила Firebase в консоли

1. Откройте [Firebase Console](https://console.firebase.google.com/)
2. Выберите ваш проект
3. Перейдите в **Realtime Database** → **Rules**
4. Скопируйте **ВСЕ** правила из файла `firebase-rules.txt` (начиная с `{` и заканчивая `}`)
5. Вставьте в редактор правил
6. Нажмите **"Publish"**

⚠️ **Важно**: Скопируйте ВСЕ правила, а не только секцию `rooms` или `users`, чтобы не сломать другие правила безопасности!

### 2. Проверить, что пользователь авторизован

Приложение автоматически проверяет авторизацию перед выполнением операций с Firebase. Если вы видите ошибки `PERMISSION_DENIED`:

1. Убедитесь, что вы вошли в систему
2. Проверьте, что правила Firebase обновлены (см. пункт 1)
3. Перезапустите приложение

### 3. Изменения в коде

Код был обновлен для правильной обработки ошибок:

- ✅ Проверка авторизации перед запуском слушателя комнат
- ✅ Корректная обработка ошибок `PERMISSION_DENIED` в `setUserOnlineStatus`
- ✅ Автоматический перезапуск слушателя при ошибке доступа, если пользователь авторизован

## Проверка после применения

После применения правил должно работать:
- ✅ Авторизованные пользователи могут читать список комнат
- ✅ Авторизованные пользователи могут устанавливать свой онлайн статус
- ✅ Ошибки `PERMISSION_DENIED` больше не должны появляться в консоли (или будут обрабатываться корректно)

## Правила для проверки

Убедитесь, что в правилах Firebase есть:

```json
"rooms": {
  ".read": "auth != null",
  ".write": "auth != null"
},
"users": {
  "$userId": {
    ".read": "auth != null",
    ".write": "auth != null && $userId == auth.uid",
    "online": {
      ".read": "auth != null",
      ".write": "auth != null && $userId == auth.uid"
    }
  }
}
```

Если эти правила отсутствуют или отличаются, обновите их согласно файлу `firebase-rules.txt`.

